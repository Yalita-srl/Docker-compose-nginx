upstream user_service {
    server user-service:8000;
}

upstream orders_service {
    server orders-service:3000;
}

upstream catalogo_service {
    server catalogo-service:8001;
}

upstream graphql_gateway {
    server graphql-gateway:4000;
}

upstream payment_notifications_service {
    server payment-notifications-service:3004;
}

server {
    listen 80;
    server_name localhost;

    # --- GraphQL Gateway (New Primary Entrypoint) ---
    location /graphql {
        proxy_pass http://graphql_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Direct REST API Access ---
    location /api/users/ {
        rewrite /api/users/(.*) /$1 break;
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/orders/ {
        rewrite /api/orders/(.*) /$1 break;
        proxy_pass http://orders_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/catalogo/ {
        rewrite /api/catalogo/(.*) /api/$1 break;
        proxy_pass http://catalogo_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/notifications/ {
        rewrite /api/notifications/(.*) /$1 break;
        proxy_pass http://payment_notifications_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /usr/share/nginx/html/static/;
    }

    location / {
        return 404;
    }
}
